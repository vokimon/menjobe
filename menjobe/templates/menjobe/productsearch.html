{% extends "menjobe/home.html" %}
{% load staticfiles %}

{% block extraheadercss %}
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/select2/3.5.0/select2-bootstrap.min.css" />
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/select2/3.5.0/select2-bootstrap.min.css" />
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/select2/3.5.0/select2.min.css" />
	<link rel="stylesheet" href="//fk.github.io/select2-bootstrap-css/css/select2-bootstrap.css" />
	<style>
		.notyetimplemented {
			display: none !important;
		}
	</style>
{% endblock extraheadercss %}

{% block extraheaderjs  %}
	<script src="//cdnjs.cloudflare.com/ajax/libs/select2/3.5.0/select2.min.js"></script>
{% endblock extraheaderjs %}


{% block content %}

<div class='container' id='page-productSearch'>

	<h2>Cerca on comprar un producte</h2>

	<div class='row'>
		<input
			class='col-xs-12 input-lg select2 form-control'
			type='hidden'
			id='productselector'
			data-placeholder='Trieu un producte del camp'
			/>
	</div>
</div>

<div class='container' id='page-productRetailers'>
	<h3 >Canals on pots trobar: <span id='producttitle'></span></h3>
	<div>
		<div id='retailersList' class='list-group'>
			<a class='list-group-item list-group-item-warning'>No heu triat cap producte</a>
		</div>
	</div>
	<div class='pull-right'>
		<a class='btn btn-success' id='addProductRetailerBtn'>
			<span class="glyphicon glyphicon-plus"></span>
			En saps cap més?
		</a>
		<div class='btn btn-warning btn-dropdown notyetimplemented'>
			<span class="glyphicon glyphicon-filter"></span>
			Filtreu
			<span class="caret"></span>
		</div>
	</div>
</div>

<hr />

<div id='page-retailerInfo' class='container hidden'>
	<div class='row'>
		<div class='panel panel-default'>
			<div class='panel-heading'>
				<h1 class='panel-title'>
					<img style='width:3ex' src="{% static 'menjobe/images/channel.png' %}" />
					<span id='retailerinfo_name'>No hi ha cap canal seleccionat</span>
				</h1>
			</div>
			<div class='panel-body row'>
				<div class='col-sm-4'>
					<address id='retailerinfo_address' style='white-space:pre-line' class='col-md-12 center-block center-text'></address>


					<div id='retailerinfo_image' class='text-center row'>
						<img class='col-xs-10 col-xs-offset-1'
							src="{% static 'menjobe/images/channel.svg' %}"
{#							src="http://esplet.bligoo.com/media/users/22/1137106/images/public/309749/DSC_0003.JPG?v=1390496569811" #}				/>
					</div>
					<div class='row hidden' id='retailerinfo_contacts'>
						<a class='btn col-xs-offset-1 col-xs-10 col-sm-offset-0 col-sm-6 btn-default' href='http://lala.com'><span class="glyphicon glyphicon-globe"></span> Blog</a>
						<a class='btn col-xs-offset-1 col-xs-10 col-sm-offset-0 col-sm-6 btn-success' href='http://lalo.com'><span class="glyphicon glyphicon-globe"></span> Comandes</a>
						<a class='btn col-xs-offset-1 col-xs-10 col-sm-offset-0 col-sm-6 btn-warning' href='mailto:me@lala.com'><span class="glyphicon glyphicon-envelope"></span> me@lala.com</a>
						<a class='btn col-xs-offset-1 col-xs-10 col-sm-offset-0 col-sm-6 btn-info'    href='tel:342-423-234'><span class="glyphicon glyphicon-earphone"></span> 342 423 234</a>
					</div>
				</div>
				<div class='col-sm-8'>
					<div id="retailerinfo_description"></div>
				</div>
				<div class='col-sm-12 text-right'>
					<div class='row'>
						<div class='btn btn-default notyetimplemented'>
							<span class="glyphicon glyphicon-map-marker"></span>
							Mapa
						</div>
						<div class='btn btn-default' id='retailerinfo_productsbtn'>
							<img style='width:1em' src='{% static 'menjobe/images/product.svg' %}'>
							Productes
							<span class="glyphicon glyphicon-chevron-right"></span>
						</div>
						<a class='btn btn-default' id='retailerinfo_editbtn'>
							<span class="glyphicon glyphicon-pencil"></span>
							Edita
						</a>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div class='container' id='page-retailerProducts'>
	<h3>Productes locals oferits per: <span id='retailertitle'></span></h3>
	<div>
		<div id='productList' class='list-group'>
			<a class='list-group-item list-group-item-warning'>No heu triat cap canal</a>
		</div>
	</div>
	<div class='pull-right'>
		<div class='btn btn-success' id='addRetailerProductBtn'>
			<span class="glyphicon glyphicon-plus"></span>
			Que tènen quelcom més?
		</div>
		<div class='btn btn-warning btn-dropdown notyetimplemented'>
			<span class="glyphicon glyphicon-filter"></span>
			Filtreu
			<span class="caret"></span>
		</div>
	</div>
</div>


<script>
$(function () {
	msg_loadingData = "S'esta carregant la informació...";
	msg_noRetailerProducts = "No hi ha productes per aquest punt de venda";
	msg_noProductRetailers = "No hi ha punts de venda pel producte";
	msg_loadError = "S'ha produït un error quan es carregava la informació";
	msg_noDescription = "No hi ha descripció";

	function productSelectFormat(product) {
		if (!product.id) return product.name; // optgroup
		return "<img class='menuicon' src='{% static 'menjobe/images/product.png' %}'/> " + product.name;
	}

	function setupProductSelector(values) {
		products = values;
		for (var i=0; i<values.length; i++)
			values[i].text = values[i].name;
		$("#productselector").select2({
			allowClear: true,
			data: products,
			formatResult: productSelectFormat,
			formatSelection: productSelectFormat,
			dropdownCssClass: "bigdrop",
//			escapeMarkup: function (m) { return m; } // as is
			}).change(function(val) {
				if (!val.added) return;
				queryProductRetailers(val.added.id, val.added.name);
			});
		}

	function queryProductRetailers(productId, productName) {
		$('#producttitle').html(productName)
		$('#retailersList').html('<a class="list-group-item">Cercant...</a>');
		$.ajax({
			type: 'GET',
			datatype: 'json',
			url: '/json/productretailers/'+productId,
			success: function(data) {
				loadProductRetailers(data);
			},
		});
		$('#addProductRetailerBtn').attr('href', "/admin/menjobe/retailpoint/");
	}

	function loadProductRetailers(retailers) {
		$('#page-retailerInfo').addClass('hidden');
		$('#page-retailerProducts').addClass('hidden');
		html=[]
		if (retailers.length==0)
			html.push(
				"<a class='list-group-item list-group-item-danger'>"
				+msg_noProductRetailers+'</a>');
		$.each(retailers, function(i, row) {
			html.push(
				$('<a>').attr({
					'class': 'list-group-item list-item-product-retailer',
					'data-id': row.id,
					}).text(row.name)
				);
			});
		$('#retailersList').html(html);
		$('.list-item-product-retailer').click(function () {
			$('#retailersList .list-group-item').removeClass('active');
			$(this).addClass("active");
			loadProductDetails($(this));
		});
	}
	$('#retailerinfo_productsbtn').click(function() {
		var page = $('#page-retailerInfo')
		var retailerId = page.attr("data-id");
		var retailerName = page.attr("data-name");
		queryRetailerProducts(retailerId, retailerName)
	});

	function loadProductDetails(link) {
		var retailerId = $(link).attr('data-id');
		var retailerName = $(link).html();
		var descriptionTag = $('#retailerinfo_description');
		$("#page-retailerInfo").attr('data-id', retailerId);
		$("#page-retailerInfo").attr('data-name', retailerName);
		descriptionTag.removeClass();
		descriptionTag.addClass("alert alert-info");
		descriptionTag.html(msg_loadingData);
		$('#retailerinfo_name').html(retailerName);
		$('#page-retailerInfo').removeClass('hidden');
		$.ajax({
			type: 'GET',
			datatype: 'json',
			url: '/json/retailer/'+retailerId,
			error: function(response) {
				descriptionTag.removeClass();
				descriptionTag.addClass("alert alert-error");
				descriptionTag.html(msg_loadError);
			},
			success: function(data) {
				descriptionTag.removeClass();
				descriptionTag.html(data.descriptionHtml || "<p class='panel-warning'>"+msg_noDescription+"</p>" );
				$('#retailerinfo_address').html(data.address);
				$('#retailerinfo_editbtn').attr('href', "/admin/menjobe/retailpoint/"+retailerId);
			},
		});
	}

	function queryRetailerProducts(retailerId, retailerName) {
		$('#page-retailerProducts').removeClass('hidden');
		$('#page-retailerProducts #retailertitle').html(retailerName)
		$('#page-retailerProducts #retailertitle').html(retailerName)
		$.ajax({
			type: 'GET',
			datatype: 'json',
			url: '/json/retailer/'+retailerId+'/products',
			error: function(response) {
				alert("TODO: No he pogut baixar els productes del canal");
			},
			success: function(products) {
				renderRetailerProducts(products);
			},
		});
	}

	function renderRetailerProducts(products) {
		$('#page-*').addClass('hidden');
		$('#page-retailerProducts').removeClass('hidden');
		html=[]
		if (products.length==0)
			html.push(
				"<a class='list-group-item list-group-item-danger'>"
				+msg_noRetailerProducts+'</a>');
		$.each(products, function(i, row) {
			html.push(
				$('<a>').attr({
					'class': 'list-group-item list-item-retailer-product',
					'data-id': row.id,
					}).text(row.name)
				);
			});
		$('#productList').html(html);
	}


	$.ajax({
		type: 'GET',
		datatype: 'json',
		url: '/json/allproducts',
		success: function(data) {
			setupProductSelector(data);
		},
	});


});

function debug(obj) {
	result = "";
	$.each(obj, function (key,val) {
		result += key+": "+val+'\n';
	});
	return result;
}

</script>

{% endblock content %}

